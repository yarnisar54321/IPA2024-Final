---
- name: Converge file for update attributes with apply
        time at reset of maintenance window
  hosts: all
  gather_facts: false
  vars:
    idrac_ip: "{{ lookup('env', 'IDRAC_IP') }}"
    idrac_port: "{{ lookup('env', 'IDRAC_PORT') }}"
  tasks:
    - name: Fetch IDRAC Data
      ansible.builtin.include_tasks:
        file: ../__get_data.yml
      vars:
        url: "https://{{ idrac_ip }}:{{ idrac_port }}/redfish/v1\
          /Systems/System.Embedded.1/Bios"

    - name: Set maintenance_window_on_reset variable
      ansible.builtin.set_fact:
        maintenance_window_on_reset: "{{ 'InMaintenanceWindowOnReset' in
         idrac_bios_uri_data.json\
         ['@Redfish.Settings']['SupportedApplyTimes'] }}"

    - name: Read file content for set_bootseq_retry variable
      ansible.builtin.command: cat /tmp/boot_seq_retry.txt
      register: file_content
      check_mode: false
      delegate_to: localhost
      changed_when: true
      when: maintenance_window_on_reset

    - name: Set set_bootseq_retry variable
      ansible.builtin.set_fact:
        set_bootseq_retry: "{{ file_content.stdout }}"
      delegate_to: localhost
      when: maintenance_window_on_reset

    - name: Get tomorrow's date
      ansible.builtin.command: date -d "+1 day" +'%Y-%m-%dT%H:%M:%S'
      register: tomorrow_date
      changed_when: false
      when: maintenance_window_on_reset

    - name: Convert tomorrow's date to string
      ansible.builtin.set_fact:
        date_str: "{{ tomorrow_date.stdout }}"
      when: maintenance_window_on_reset

    - name: Fetch IDRAC time offset
      ansible.builtin.include_tasks:
        file: ../__get_data.yml
      vars:
        url: "https://{{ idrac_ip }}:{{ idrac_port }}/redfish/v1\
          /Managers/iDRAC.Embedded.1"
      when: maintenance_window_on_reset

    - name: Set the local offset
      ansible.builtin.set_fact:
        local_offset: "{{ idrac_bios_uri_data.json.DateTimeLocalOffset }}"
      when:
        - maintenance_window_on_reset
        - idrac_bios_uri_data.json.DateTimeLocalOffset is defined

    - name: Update attributes with apply time at reset of maintenance window
      ansible.builtin.import_role:
        name: dellemc.openmanage.idrac_bios
      vars:
        hostname: "{{ lookup('env', 'IDRAC_IP') }}"
        username: "{{ lookup('env', 'IDRAC_USER') }}"
        password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
        validate_certs: false
        apply_time: InMaintenanceWindowOnReset
        maintenance_window:
          start_time: "{{ date_str }}{{ local_offset }}"
          duration: 600
        attributes:
          BootSeqRetry: "{{ set_bootseq_retry }}"
      when: maintenance_window_on_reset

    - name: Assert update attributes with apply time at reset
            of maintenance window normal mode
      ansible.builtin.assert:
        that:
          - "'Successfully committed changes. The job is in pending state'
            in idrac_bios_out.attributes.status_msg"
          - idrac_bios_out.reset_bios.skipped
          - idrac_bios_out.clear_pending.skipped
      when:
        - not ansible_check_mode
        - maintenance_window_on_reset

    - name: Assert Update attributes with apply time at reset of
            maintenance window in check mode
      ansible.builtin.assert:
        that:
          - idrac_bios_out.attributes.status_msg == "Changes found to
            be applied."
      when:
        - ansible_check_mode
        - maintenance_window_on_reset
