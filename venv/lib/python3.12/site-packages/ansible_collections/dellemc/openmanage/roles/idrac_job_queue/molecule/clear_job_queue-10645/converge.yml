---
- name: Job Queue Clear Scenarios
  hosts: all
  gather_facts: false
  tasks:
    - name: Setting input facts
      ansible.builtin.set_fact:
        input: &input
          hostname: "{{ lookup('env', 'IDRAC_IP') }}"
          username: "{{ lookup('env', 'IDRAC_USER') }}"
          password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
          idrac_port: "{{ lookup('env', 'IDRAC_PORT') }}"
          validate_certs: false
      no_log: true

    - name: Creating a job (first job)
      ansible.builtin.include_tasks:
        file: ../_create_job.yml

    - name: Clear the job queue (first job)
      ansible.builtin.include_role:
        name: "idrac_job_queue"
      vars:
        <<: *input
        clear_job_queue: true

    - name: "Verifying job queue clear"
      ansible.builtin.assert:
        that:
          - idrac_job_queue_out.msg == "The job queue has been cleared successfully."

    - name: Waiting for the data to be available on iDRAC
      ansible.builtin.wait_for:
        timeout: 180

    - name: Creating a job (second job)
      ansible.builtin.include_tasks:
        file: ../_create_job.yml

    - name: Force clear the job queue
      ansible.builtin.include_role:
        name: "idrac_job_queue"
      vars:
        <<: *input
        clear_job_queue: true
        force: true

    - name: "Verifying force job queue clear"
      ansible.builtin.assert:
        that:
          - idrac_job_queue_out.msg == "The job queue has been cleared successfully."

    - name: Waiting for the data to be available on iDRAC.
      ansible.builtin.wait_for:
        timeout: 180

    - name: Clear the job queue (second job)
      block:
        - name: Clear the job queue when there is no jobs
          ansible.builtin.include_role:
            name: "idrac_job_queue"
          vars:
            <<: *input
            clear_job_queue: true

      rescue:
        - name: "Verifying job queue clear when there is no job"
          ansible.builtin.assert:
            that:
              - idrac_job_queue_out.msg == "There are no jobs in the job queue."

    - name: Creating a job (third job)
      ansible.builtin.include_tasks:
        file: ../_create_job.yml

    - name: Clear the job queue (third job)
      block:
        - name: Clear the job queue when any of the job is not in state to be deleted
          ansible.builtin.include_role:
            name: "idrac_job_queue"
          vars:
            <<: *input
            clear_job_queue: true
      rescue:
        - name: "Verifying job queue clear"
          ansible.builtin.assert:
            that:
              - idrac_job_queue_out.msg == "One or more jobs cannot be deleted, Retry the operation or
                delete the jobs by checking the job status."
