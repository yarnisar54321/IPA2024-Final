---
- name: Converge
  hosts: all
  gather_facts: false
  vars:
    success_msg: "iDRAC reset operation completed successfully"

  tasks:
    - name: Setup Tasks
      ansible.builtin.include_tasks:
        file: ../_setup.yml

    - name: Performing force reset operation with wait_for_idrac
      block:
        - name: Pre-requisite - updating settings before iDRAC reset
          ansible.builtin.include_tasks:
            file: ../_get_or_update_settings.yml
          vars:
            operation: update_settings

        - name: Performing iDRAC reset with wait
          ansible.builtin.import_role:
            name: dellemc.openmanage.idrac_reset
          vars:
            hostname: "{{ idrac_ip }}"
            username: "{{ idrac_user }}"
            password: "{{ idrac_password }}"
            reset_to_default: "Default"
            wait_for_idrac: true

        - name: Fetching settings from iDRAC post reset
          ansible.builtin.include_tasks:
            file: ../_get_or_update_settings.yml

        - name: Asserting after iDRAC reset
          ansible.builtin.assert:
            that:
              - idrac_reset_out.msg == "{{ success_msg }}"
              - idrac_has_default_settings
