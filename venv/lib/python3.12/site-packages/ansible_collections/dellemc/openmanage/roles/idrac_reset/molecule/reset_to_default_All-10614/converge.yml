---
- name: Converge
  hosts: all
  gather_facts: false
  vars:
    reset_operation: "All"
    success_msg: "iDRAC reset operation completed successfully"

  tasks:
    - name: Setup Tasks
      ansible.builtin.include_tasks:
        file: ../_setup.yml

    - name: Performing reset_to_default_all operation
      block:
        - name: Pre-requisite - Export iDRAC settings before reset
          ansible.builtin.include_tasks:
            file: ../_export_scp_via_uri.yml

        - name: Pre-requisite - Updating settings to non-default before reset
          ansible.builtin.include_tasks:
            file: ../_get_or_update_settings.yml
          vars:
            operation: update_settings

        - name: Performing iDRAC reset with reset to default all
          ansible.builtin.import_role:
            name: dellemc.openmanage.idrac_reset
          vars:
            hostname: "{{ idrac_ip }}"
            username: "{{ idrac_user }}"
            password: "{{ idrac_password }}"
            reset_to_default: "{{ reset_operation }}"

        - name: Updating password in iDRAC after reset
          ansible.builtin.include_tasks:
            file: ../_update_pass.yml

        - name: Fetching settings from iDRAC post reset
          ansible.builtin.include_tasks:
            file: ../_get_or_update_settings.yml

        - name: Asserting after iDRAC reset
          ansible.builtin.assert:
            that:
              - idrac_reset_out.msg == success_msg
              - idrac_has_default_settings

      always:
        - name: Importing SCP after reset
          ansible.builtin.include_tasks:
            file: ../_import_scp_via_uri.yml
