---
- name: Prepare
  hosts: all
  gather_facts: false
  vars:
    idrac_user_name: "moleculeTest"
  tasks:
    - name: Get Server generation
      ansible.builtin.include_tasks:
        file: ../resources/idrac_user/_get_server_generation.yml

    - name: Setting up minimum custom_privilege value dynamically
      ansible.builtin.set_fact:
        csp: "{{  0 if model | int < 17 else 1 }}"
      no_log: true

    - name: Configure a new iDRAC user with minimum required parameters
      ansible.builtin.import_role:
        name: dellemc.openmanage.idrac_user
      vars:
        hostname: "{{ lookup('env', 'IDRAC_IP') }}"
        username: "{{ lookup('env', 'IDRAC_USER') }}"
        password: "{{ lookup('env', 'IDRAC_PASSWORD') }}"
        validate_certs: false
        state: present
        user_name: "{{ idrac_user_name }}"
        user_password: "#1234Abc"
        custom_privilege: "{{ csp | int }}"
