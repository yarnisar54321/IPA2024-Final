---
- name: Form Cluster
  hosts: ravendb_nodes
  gather_facts: no
  
  tasks:
  - name: Join Node B as Watcher (check_mode)
    become: true
    run_once: true
    ravendb.ravendb.node:
      tag: B
      type: "Watcher"
      url: "https://b.ravendbansible.development.run"
      leader_url: "https://a.ravendbansible.development.run"
      certificate_path: /etc/ravendb/security/admin.client.combined.pem
    check_mode: yes

  - name: Join Node B as Watcher
    become: true
    run_once: true
    ravendb.ravendb.node:
      tag: B
      type: "Watcher"
      url: "https://b.ravendbansible.development.run"
      leader_url: "https://a.ravendbansible.development.run"
      certificate_path: /etc/ravendb/security/admin.client.combined.pem

  - name: Join Node B as Watcher (idempotency check)
    become: true
    run_once: true
    ravendb.ravendb.node:
      tag: B
      type: "Watcher"
      url: "https://b.ravendbansible.development.run"
      leader_url: "https://a.ravendbansible.development.run"
      certificate_path: /etc/ravendb/security/admin.client.combined.pem

  - name: Join Node C as Member
    become: true
    run_once: true
    ravendb.ravendb.node:
      tag: C
      url: "https://c.ravendbansible.development.run"
      leader_url: "https://a.ravendbansible.development.run"
      certificate_path: /etc/ravendb/security/admin.client.combined.pem